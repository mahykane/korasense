// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  TENANT_ADMIN
  MEMBER
}

enum DocumentType {
  POLICY
  INCIDENT
  ARCHITECTURE
  CHAT
  TABLE
  OTHER
}

enum DocumentSource {
  SENSE
  MANUAL_UPLOAD
  DEMO_SEED
}

enum DocumentStatus {
  UPLOADED
  PARSED
  EMBEDDED
}

enum ChunkStrategy {
  LINE
  PARAGRAPH
  SECTION
  TABLE
  SLIDING
  PAGE
}

enum FeedbackLabel {
  HELPFUL
  UNHELPFUL
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members           TenantMember[]
  documents         Document[]
  documentChunks    DocumentChunk[]
  qaSessions        QaSession[]
  qaMetrics         QaMetrics[]
  qaFeedback        QaFeedback[]
  riskAssessments   RiskAssessment[]
  playbooks         Playbook[]
  externalApiKeys   ExternalApiKey[]
}

model User {
  id          String   @id @default(uuid())
  clerkUserId String   @unique
  email       String
  name        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenantMembers    TenantMember[]
  qaSessions       QaSession[]
  qaFeedback       QaFeedback[]
  riskAssessments  RiskAssessment[]
}

model TenantMember {
  id        String   @id @default(uuid())
  tenantId  String
  userId    String
  role      Role     @default(MEMBER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
}

model ExternalApiKey {
  id        String   @id @default(uuid())
  tenantId  String
  key       String   @unique
  label     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model Document {
  id               String         @id @default(uuid())
  tenantId         String
  title            String
  originalFileName String
  storageUrl       String?
  docType          DocumentType   @default(OTHER)
  source           DocumentSource @default(MANUAL_UPLOAD)
  status           DocumentStatus @default(UPLOADED)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  tenant Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  chunks DocumentChunk[]
}

model DocumentChunk {
  id             String        @id @default(uuid())
  documentId     String
  tenantId       String
  chunkIndex     Int
  text           String        @db.Text
  chunkStrategy  ChunkStrategy @default(PARAGRAPH)
  pageNumber     Int?
  sectionTitle   String?
  qdrantPointId  String        @unique
  createdAt      DateTime      @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, documentId])
  @@index([qdrantPointId])
}

model QaSession {
  id              String   @id @default(uuid())
  tenantId        String
  userId          String?
  question        String   @db.Text
  finalAnswer     String   @db.Text
  agentTrace      Json
  qualityScore    Float?
  totalLatencyMs  Int
  createdAt       DateTime @default(now())

  tenant   Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  metrics  QaMetrics[]
  feedback QaFeedback[]

  @@index([tenantId, createdAt])
}

model QaMetrics {
  id                  String   @id @default(uuid())
  qaSessionId         String
  tenantId            String
  retrievalK          Int
  retrievalUsed       Int
  retrievalLatencyMs  Int
  geminiLatencyMs     Int
  createdAt           DateTime @default(now())

  qaSession QaSession @relation(fields: [qaSessionId], references: [id], onDelete: Cascade)
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
}

model QaFeedback {
  id          String        @id @default(uuid())
  qaSessionId String
  tenantId    String
  userId      String
  label       FeedbackLabel
  comment     String?       @db.Text
  createdAt   DateTime      @default(now())

  qaSession QaSession @relation(fields: [qaSessionId], references: [id], onDelete: Cascade)
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
}

model RiskAssessment {
  id                 String    @id @default(uuid())
  tenantId           String
  userId             String?
  domain             String
  objective          String    @db.Text
  timeHorizonMonths  Int
  riskRegister       Json
  overallLevel       RiskLevel
  createdAt          DateTime  @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
}

model Playbook {
  id           String   @id @default(uuid())
  tenantId     String?
  riskPattern  String
  title        String
  description  String   @db.Text
  steps        Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([riskPattern])
}
